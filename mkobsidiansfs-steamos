#!/bin/bash
set -e

check_command() {
  local cmd="$1"
  local extra_msg="$2"
  if ! command -v "$cmd" &>/dev/null; then
    echo "Error: Required command '$cmd' not found. Please install it."
    [[ -n "$extra_msg" ]] && echo "$extra_msg"
    exit 1
  fi
}

if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root."
  exit 1
fi

check_command git

BUILD_DIR="obsidian_rootfs"
PACKAGES="base networkmanager sudo vim nano efibootmgr python squashfs-tools arch-install-scripts base-devel git gptfdisk f2fs-tools grub gpm wget os-prober pv 7zip a52dec aardvark-dns abseil-cpp accounts-qml-module accountsservice acl adobe-source-code-pro-fonts adwaita-cursors adwaita-icon-theme adwaita-icon-theme-legacy aha alsa-card-profiles alsa-lib alsa-plugins alsa-topology-conf alsa-ucm-conf alsa-utils amd-ucode-neptune anthy aom appstream appstream-qt arch-install-scripts archlinux-appstream-data archlinux-keyring argon2 aribb24 ark aspell aspell-en assimp at-spi2-core atomupd-daemon attica attr audit avahi baloo baloo-widgets base bash bash-completion bats binutils blas bluedevil bluez bluez-libs bluez-qt bluez-utils bolt boost-libs breakpad breeze breeze-grub breeze-gtk breeze-icons brotli btop btrfs-progs bubblewrap bzip2 ca-certificates ca-certificates-mozilla ca-certificates-utils cairo cairomm-1.16 cantarell-fonts caps casync catatonit cblas cdparanoia cfitsio cifs-utils clinfo composefs conmon containers-common convertlit coreutils cpupower criu crun cryptsetup cups cups-filters cups-pdf curl dav1d db5.3 dbus dbus-broker dbus-broker-units dbus-units dconf ddcutil default-cursors desktop-file-utils desync device-mapper diffutils ding-libs discount discover distrobox djvulibre dmidecode dolphin dos2unix dosfstools double-conversion drkonqi drm_info drm_janitor duktape e2fsprogs earlyoom ebook-tools editorconfig-core-c efibootmgr efivar elfutils ell enchant evtest exfat-utils exiv2 expat f3 faad2 fatresize fd ffmpeg ffmpeg4.4 ffmpegthumbs fftw file filelight filesystem findutils firewalld fish flac flatpak flatpak-kcm fontconfig frameworkintegration freeglut freerdp freerdp2 freetype2 fribidi fuse-common fuse-overlayfs fuse2 fuse3 fwupd-efi fwupd-minimal galileo-mura gamemode gamescope gawk gc gcc-libs gdb gdb-common gdbm gdk-pixbuf2 gettext ghostscript giflib git glew glfw glib-networking glib2 glibc glibmm-2.68 glslang glu gmp gnulib-l10n gnupg gnutls gobject-introspection-runtime gocryptfs gperftools gpgme gpm gptfdisk gpu-trace graphene graphite grep grub gsettings-desktop-schemas gsettings-system-schemas gsm gssdp gssproxy gst-plugin-pipewire gst-plugins-bad-libs gst-plugins-base gst-plugins-base-libs gstreamer gtest gtk-update-icon-cache gtk3 gtk4 gtkmm-4.0 guile gupnp gupnp-igd gwenview gzip harfbuzz hicolor-icon-theme hidapi highway holo-desync holo-dmi-rules holo-earlyoom holo-fstab-repair holo-glibc-locales holo-keyring holo-nfs-utils-tmpfiles holo-nix-offload holo-sudo holo-zram-swap htop hunspell hwdata hwloc i2c-tools iana-etc ibus ibus-anthy ibus-hangul ibus-pinyin ibus-table ibus-table-cangjie-lite icu ijs imath inputplumber iotop iproute2 iptables iputils iso-codes iw iwd jansson jasper jbig2dec jbigkit jq json-c json-glib jsoncpp jupiter-dock-updater-bin jupiter-fan-control jupiter-firewall jupiter-hw-support jupiter-legacy-support jupiter-resolved-nomdns jupiter-steamos-log-submitter kaccounts-integration kactivitymanagerd karchive kate kauth kbd kbookmarks kcmutils kcodecs kcolorpicker kcolorscheme kcompletion kconfig kconfigwidgets kcontacts kcoreaddons kcrash kdbusaddons kde-cli-tools kde-gtk-config kdeclarative kdeconnect kdecoration kded kdeplasma-addons kdesu kdialog kdnssd kdsoap-qt6 kdsoap-ws-discovery-client kdumpst kexec-tools keyutils kfilemetadata kgamma kglobalaccel kglobalacceld kguiaddons kholidays ki18n kiconthemes kidletime kimageannotator kinfocenter kio kio-extras kio-fuse kirigami kirigami-addons kitemmodels kitemviews kitty-terminfo kjobwidgets kmenuedit kmod knewstuff knotifications knotifyconfig konsole kpackage kparts kpeople kpipewire kpmcore kpty kquickcharts krb5 krdp krunner kscreen kscreenlocker kservice ksshaskpass kstatusnotifieritem ksvg ksystemstats ktexteditor ktextwidgets kunitconversion kuserfeedback kwallet kwallet-pam kwayland kwidgetsaddons kwin kwindowsystem kwrited kxmlgui l-smash lame lapack layer-shell-qt lcms2 ldb less lib32-alsa-lib lib32-alsa-plugins lib32-brotli lib32-bzip2 lib32-curl lib32-dbus lib32-e2fsprogs lib32-expat lib32-flac lib32-fontconfig lib32-freetype2 lib32-gamemode lib32-gamescope lib32-gcc-libs lib32-glib2 lib32-glibc lib32-harfbuzz lib32-icu lib32-json-c lib32-keyutils lib32-krb5 lib32-libasyncns lib32-libcap lib32-libdrm lib32-libelf lib32-libffi lib32-libgcrypt lib32-libglvnd lib32-libgpg-error lib32-libidn2 lib32-libldap lib32-libnghttp2 lib32-libnghttp3 lib32-libnm lib32-libnsl lib32-libogg lib32-libpciaccess lib32-libpipewire lib32-libpng lib32-libpsl lib32-libpulse lib32-libsndfile lib32-libssh2 lib32-libtasn1 lib32-libtirpc lib32-libunistring lib32-libunwind lib32-libva lib32-libva-mesa-driver lib32-libvdpau lib32-libvorbis lib32-libx11 lib32-libxau lib32-libxcb lib32-libxcrypt lib32-libxcrypt-compat lib32-libxdamage lib32-libxdmcp lib32-libxext lib32-libxfixes lib32-libxinerama lib32-libxml2 lib32-libxshmfence lib32-libxss lib32-libxxf86vm lib32-llvm-libs lib32-lm_sensors lib32-mangohud lib32-mesa lib32-mesa-vdpau lib32-ncurses lib32-nspr lib32-nss lib32-openal lib32-openssl lib32-opus lib32-p11-kit lib32-pam lib32-pcre2 lib32-pipewire lib32-renderdoc-minimal lib32-spirv-llvm-translator lib32-spirv-tools lib32-sqlite lib32-systemd lib32-util-linux lib32-vulkan-icd-loader lib32-vulkan-radeon lib32-wayland lib32-xcb-util-keysyms lib32-xz lib32-zlib lib32-zstd libaccounts-glib libaccounts-qt libaio libarchive libass libassuan libasyncns libatasmart libavc1394 libavif libb2 libblockdev libblockdev-crypto libblockdev-fs libblockdev-loop libblockdev-mdraid libblockdev-nvme libblockdev-part libblockdev-swap libbluray libbpf libbs2b libbsd libbytesize libcanberra libcap libcap-ng libcbor libcec libcloudproviders libcolord libcups libcupsfilters libdaemon libdatrie libdbusmenu-glib libdbusmenu-gtk3 libdc1394 libdca libdecor libdeflate libdisplay-info libdmtx libdovi libdrm libdvbpsi libdvdnav libdvdread libebml libedit libei libelf libepoxy libevdev libevent libexif libfakekey libfdk-aac libffi libfontenc libfreeaptx libgcrypt libgirepository libglvnd libgpg-error libgudev libhangul libibus libice libidn libidn2 libiec61883 libiio libimobiledevice libimobiledevice-glue libinih libinput libjcat libjpeg-turbo libjxl libkdcraw libkexiv2 libksba libkscreen libksysguard liblc3 libldac libldap libmad libmalcontent libmatroska libmbim libmd libmfx libmm-glib libmng libmnl libmodplug libmpcdec libmpeg2 libmtp libmysofa libndp libnet libnetfilter_conntrack libnewt libnfnetlink libnftnl libnghttp2 libnghttp3 libnice libnl libnm libnotify libnsl libnvme libogg libopenmpt libp11-kit libpaper libpcap libpciaccess libpfm libpgm libpipewire libplacebo libplasma libplist libpng libppd libproxy libpsl libpulse libqaccessibilityclient-qt6 libqalculate libqmi libqrtr-glib libraw libraw1394 librsvg libsamplerate libsasl libseccomp libsecret libserialport libsigc++-3.0 libsm libsndfile libsodium libsoup3 libsoxr libspectre libssh libssh2 libstemmer libsysprof-capture libtar libtasn1 libteam libthai libtheora libtiff libtirpc libtommath libtool libtraceevent libtracefs libunibreak libunistring libunwind libupnp libusb libusbmuxd libutempter libva libva-intel-driver libva-mesa-driver libvdpau libverto libvlc libvorbis libvpl libvpx libwacom libwbclient libwebp libwireplumber libx11 libxau libxaw libxcb libxcomposite libxcrypt libxcrypt-compat libxcursor libxcvt libxdamage libxdmcp libxext libxfixes libxfont2 libxft libxi libxinerama libxkbcommon libxkbcommon-x11 libxkbfile libxml2 libxmlb libxmu libxpm libxrandr libxrender libxres libxshmfence libxslt libxss libxt libxtst libxv libxxf86vm libyaml libyuv libzip licenses lilv linux-api-headers linux-firmware-neptune linux-firmware-neptune-whence linux-neptune-611 llvm-libs lm_sensors lmdb lsb-release lsof lua luajit luit lv2 lz4 lzo makedumpfile maliit-framework maliit-keyboard mandoc mangohud md4c mdadm media-player-info mesa mesa-utils mesa-vdpau milou minizip mkinitcpio mkinitcpio-busybox mobile-broadband-provider-info modemmanager modemmanager-qt mpdecimal mpfr mpg123 mtdev nano ncdu ncurses netavark nethogs nettle networkmanager networkmanager-openvpn networkmanager-qt nfs-utils nfsidmap nftables noise-suppression-for-voice noto-fonts noto-fonts-cjk npth nspr nss nss-mdns ntfs-3g numactl nvme-cli ocean-sound-theme ocl-icd okular onetbb oniguruma openal opencore-amr opencv openexr openjpeg2 openssh openssl openvpn openxr opus orc ostree oxygen oxygen-sounds p11-kit p8-platform pacman pacman-mirrorlist pam pambase pango pangomm-2.48 parallel parted partitionmanager paru passt pavucontrol pciutils pcre pcre2 pcsclite perf perl perl-error perl-mailtools perl-timedate phonon-qt6 phonon-qt6-vlc pinentry pipewire pipewire-alsa pipewire-audio pipewire-jack pipewire-pulse pipewire-v4l2 pipewire-x11-bell pixman pkcs11-helper plasma-activities plasma-activities-stats plasma-browser-integration plasma-desktop plasma-disks plasma-firewall plasma-integration plasma-meta plasma-nm plasma-pa plasma-remotecontrollers plasma-systemmonitor plasma-thunderbolt plasma-vault plasma-wayland-protocols plasma-welcome plasma-workspace plasma-workspace-wallpapers plasma5support podman polkit polkit-kde-agent polkit-qt6 poppler poppler-data poppler-qt6 popt portaudio powerdevil powertop ppp print-manager prison procps-ng protobuf protobuf-c psmisc pulseaudio-qt purpose python python-aiohappyeyeballs python-aiohttp python-aiosignal python-anyio python-attrs python-capng python-certifi python-click python-crcmod python-dbus python-dbus-next python-evdev python-frozenlist python-gobject python-h11 python-hid python-httpcore python-httpx python-idna python-minidump python-multidict python-progressbar python-protobuf python-psutil python-pyalsa python-pyaml python-pyelftools python-pyenchant python-pygdbmi python-semantic-version python-sentry_sdk python-sniffio python-typing_extensions python-urllib3 python-utils python-yaml python-yarl pyzy qca-qt6 qcoro qpdf qqc2-breeze-style qqc2-desktop-style qrencode qt5-base qt5-declarative qt5-feedback qt5-graphicaleffects qt5-multimedia qt5-quickcontrols2 qt5-svg qt5-tools qt5-translations qt5-wayland qt5-x11extras qt6-5compat qt6-base qt6-connectivity qt6-declarative qt6-imageformats qt6-multimedia qt6-multimedia-ffmpeg qt6-positioning qt6-quick3d qt6-quicktimeline qt6-sensors qt6-shadertools qt6-speech qt6-svg qt6-tools qt6-translations qt6-virtualkeyboard qt6-wayland qt6-webchannel qt6-webengine qt6-websockets qt6-webview qtkeychain-qt6 rauc rav1e re2 readline renderdoc-minimal ripgrep ripgrep-all rpcbind rsync rtkit rubberband rxvt-unicode-terminfo sbc sddm sddm-kcm sdl2 sdl2_ttf seatd sed serd shaderc shadow shared-mime-info signon-kwallet-extension signon-plugin-oauth2 signon-ui signond slang smartmontools smbclient snappy socat solid sonnet sord sound-theme-freedesktop source-highlight spectacle speex speexdsp spirv-llvm-translator spirv-tools sqlite squashfs-tools sratom srt sshfs steam-im-modules steam-jupiter-oobe steam_notif_daemon steamdeck-dsp steamdeck-kde-presets steamos-atomupd-client steamos-customizations-jupiter steamos-devkit-service steamos-efi steamos-kdumpst-layer steamos-log-submitter steamos-manager steamos-networking-tools steamos-powerbuttond steamos-reset steamos-systemreport steamos-tweak-mtu-probing strace sudo svt-av1 syndication syntax-highlighting systemd systemd-libs systemd-sysvcompat systemsettings taglib talloc tar tcl tdb tevent threadweaver tinysparql tk tmux tpm2-tss trace-cmd tree tslib ttf-dejavu ttf-hack ttf-twemoji-default tzdata udisks2 umr unrar unzip upower usbhid-gadget-passthru usbutils util-linux util-linux-libs v4l-utils vapoursynth verdict vid.stab vim vim-runtime vkmark vlc vmaf volume_key vpower vulkan-headers vulkan-icd-loader vulkan-radeon vulkan-tools wakehook wayland wayland-utils webrtc-audio-processing-1 wget which wireguard-tools wireless-regdb wireless_tools wireplumber wpa_supplicant x264 x265 xbindkeys xbitmaps xcb-proto xcb-util xcb-util-cursor xcb-util-errors xcb-util-image xcb-util-keysyms xcb-util-renderutil xcb-util-wm xdg-dbus-proxy xdg-desktop-portal xdg-desktop-portal-gtk xdg-desktop-portal-kde xdg-user-dirs xdg-utils xdotool xf86-input-libinput xf86-video-amdgpu xkeyboard-config xorg-fonts-encodings xorg-server xorg-server-common xorg-setxkbmap xorg-xauth xorg-xdpyinfo xorg-xhost xorg-xkbcomp xorg-xmessage xorg-xprop xorg-xrandr xorg-xrdb xorg-xset xorg-xsetroot xorg-xwayland xorg-xwininfo xorgproto xsettingsd xterm xvidcore xxhash xz yajl zenity-gtk3 zeromq zimg zip zix zlib zram-generator zsh zstd zxing-cpp"
HAVE_AUR="yay-bin"
YAY_GET="obsidianctl-git plugind-git obsidianwall-git obsidian-control"
OUTPUT_SFS="system.sfs"
TIMEZONE=""
NETUPDATE=""
HOSTNAME="steambtw"
SERVICES="NetworkManager gpm plugind"
ROOT_HAVEPASSWORD=""
CUSTOM_SCRIPTS_DIR=""
ADMIN_USER="user"
ADMIN_DOTFILES=""
ADMIN_PASSWORD=""
ADMIN_DOTFILES_TYPE=""
POST_INSTALL=""
STEAMOS_VERSION="main"                                                     # latest SteamOS
STEAMOS_MIRROR="https://steamdeck-packages.steamos.cloud/archlinux-mirror" # please do not change
if [[ "$1" != "" ]]; then
  source "$1"
  echo ">>> Custom config file specified: $1"
fi

if [[ "$2" != "" ]]; then
  OUTPUT_SFS="$2"
  echo ">>> Custom sfs output: $2"
fi

if [[ -n "$oosnopass" ]]; then
  ROOT_HAVEPASSWORD="yesssssss"
  echo ">>> No password enabled via env var."
fi

check_command mksquashfs "mksquashfs is prodvided by squashfs-tools on Arch Linux"
check_command pacstrap "pacstrap is part of the arch-install-scripts package on Arch Linux."
check_command arch-chroot "arch-chroot is part of the arch-install-scripts package on Arch Linux."

echo ">>> Cleaning up any previous build directories..."
rm -rf "$BUILD_DIR"
rm -f "$OUTPUT_SFS"
mkdir -p "$BUILD_DIR"
echo ">>> Creating SteamOS pacman configuration..."
PACMAN_CONF=$(mktemp)
STEAMOS_MIRRORLIST=$(mktemp)
ARCH_MIRRORLIST=$(mktemp)

echo "Server = ${STEAMOS_MIRROR}/\$repo/os/\$arch" >"$STEAMOS_MIRRORLIST"
echo "Server = https://mirror.rackspace.com/archlinux/\$repo/os/\$arch" >"$ARCH_MIRRORLIST"

cat >"$PACMAN_CONF" <<EOF
[options]
HoldPkg     = pacman glibc
Architecture = x86_64
CheckSpace
SigLevel    = Never
LocalFileSigLevel = Optional

[core-${STEAMOS_VERSION}]
Server = ${STEAMOS_MIRROR}/core-${STEAMOS_VERSION}/os/\$arch

[extra-${STEAMOS_VERSION}]
Server = ${STEAMOS_MIRROR}/extra-${STEAMOS_VERSION}/os/\$arch

[multilib-${STEAMOS_VERSION}]
Server = ${STEAMOS_MIRROR}/multilib-${STEAMOS_VERSION}/os/\$arch

[jupiter-${STEAMOS_VERSION}]
Server = ${STEAMOS_MIRROR}/jupiter-${STEAMOS_VERSION}/os/\$arch

[holo-${STEAMOS_VERSION}]
Server = ${STEAMOS_MIRROR}/holo-${STEAMOS_VERSION}/os/\$arch

[core]
Server = https://mirror.rackspace.com/archlinux/\$repo/os/\$arch

[extra]
Server = https://mirror.rackspace.com/archlinux/\$repo/os/\$arch

[multilib]
Server = https://mirror.rackspace.com/archlinux/\$repo/os/\$arch
EOF

echo ">>> Bootstrapping SteamOS ${STEAMOS_VERSION} base system with pacstrap..."
echo ">>> This may take some time, depending on your internet connection."
PACKAGES=$(echo $PACKAGES | tr ' ' '\n')
pacman -Sy --config "$PACMAN_CONF"
PACKAGES=$(echo $PACKAGES) # weird ass hack to remove extra spaces lmfao
if ! pacstrap -C "$PACMAN_CONF" -M -c -K "$BUILD_DIR" $PACKAGES --overwrite '*'; then
  echo "Error: pacstrap failed to install the base system."
  rm -f "$PACMAN_CONF" "$STEAMOS_MIRRORLIST" "$ARCH_MIRRORLIST"
  exit 1
fi

mkdir -p "$BUILD_DIR/etc/pacman.d"
cp "$STEAMOS_MIRRORLIST" "$BUILD_DIR/etc/pacman.d/steamos-mirrorlist"
cp "$ARCH_MIRRORLIST" "$BUILD_DIR/etc/pacman.d/mirrorlist"
cat >"$BUILD_DIR/etc/pacman.conf" <<EOF
[options]
HoldPkg     = pacman glibc
Architecture = x86_64
CheckSpace
SigLevel    = Required DatabaseOptional
LocalFileSigLevel = Optional

[core-${STEAMOS_VERSION}]
Include = /etc/pacman.d/steamos-mirrorlist

[extra-${STEAMOS_VERSION}]
Include = /etc/pacman.d/steamos-mirrorlist

[multilib-${STEAMOS_VERSION}]
Include = /etc/pacman.d/steamos-mirrorlist

[jupiter-${STEAMOS_VERSION}]
Include = /etc/pacman.d/steamos-mirrorlist

[holo-${STEAMOS_VERSION}]
Include = /etc/pacman.d/steamos-mirrorlist

[core]
Include = /etc/pacman.d/mirrorlist

[extra]
Include = /etc/pacman.d/mirrorlist

[multilib]
Include = /etc/pacman.d/mirrorlist
EOF

rm -f "$PACMAN_CONF" "$STEAMOS_MIRRORLIST" "$ARCH_MIRRORLIST"
if [[ -n "$ADMIN_USER" ]]; then
  echo "Creating user $ADMIN_USER..."
  arch-chroot "$BUILD_DIR" useradd -m -G wheel -s /bin/bash "$ADMIN_USER"

  if [[ -n "$ADMIN_DOTFILES_TYPE" ]]; then
    if [[ "$ADMIN_DOTFILES_TYPE" == "HOME" ]]; then
      arch-chroot "$BUILD_DIR" su - "$ADMIN_USER" -c "git clone '$ADMIN_DOTFILES' ~/dotfiles && cp -r ~/dotfiles/.??* ~/ && rm -rf ~/.git"
    elif [[ "$ADMIN_DOTFILES_TYPE" == "CONFIG" ]]; then
      arch-chroot "$BUILD_DIR" su - "$ADMIN_USER" -c "git clone '$ADMIN_DOTFILES' ~/.config"
    else
      cp -r /home/"$ADMIN_DOTFILES_TYPE"/.??* "$BUILD_DIR/home/$ADMIN_USER/"
    fi
    if [[ -n "$POST_INSTALL" ]]; then
      arch-chroot "$BUILD_DIR" su - "$ADMIN_USER" -c "$POST_INSTALL"
    fi
  fi

  arch-chroot "$BUILD_DIR" sh -c "echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"
  arch-chroot "$BUILD_DIR" visudo -c

  if [[ -n "$HAVE_AUR" ]]; then
    mount --bind "$BUILD_DIR" "$BUILD_DIR"
    arch-chroot "$BUILD_DIR" sh -c "cat > /home/$ADMIN_USER/install-yay.sh" <<'EOF'
#!/bin/bash
cd ~
git clone --branch yay-bin --single-branch https://github.com/archlinux/aur.git yay-bin
cd yay-bin
makepkg --noconfirm --skippgpcheck -si
EOF
    arch-chroot "$BUILD_DIR" chmod +x /home/$ADMIN_USER/install-yay.sh
    arch-chroot "$BUILD_DIR" su - "$ADMIN_USER" -c "/home/$ADMIN_USER/install-yay.sh"
    if [[ -n "$YAY_GET" ]]; then
      arch-chroot "$BUILD_DIR" su - "$ADMIN_USER" -c "yay -S --noconfirm $YAY_GET"
      touch "$BUILD_DIR/obsidianctl-aur-installed"
    fi
    arch-chroot "$BUILD_DIR" rm /home/$ADMIN_USER/install-yay.sh
  fi

  echo ">>> Please set the password for $ADMIN_USER"
  if [[ -n "$ADMIN_PASSWORD" ]]; then
    arch-chroot "$BUILD_DIR" bash -c "echo '${ADMIN_USER}:${ADMIN_PASSWORD}' | chpasswd"
    echo ">>> Password defined in config. skipping..."
  else
    arch-chroot "$BUILD_DIR" passwd "$ADMIN_USER"
  fi
fi

if [[ -n "$TIMEZONE" ]]; then
  echo "Setting timezone to $TIMEZONE..."
  arch-chroot "$BUILD_DIR" ln -sf "/usr/share/zoneinfo/$TIMEZONE" "/etc/localtime"
fi

if [[ -n "$HOSTNAME" ]]; then
  echo "Setting hostname to $HOSTNAME..."
  echo "$HOSTNAME" >"$BUILD_DIR/etc/hostname"
fi

echo ">>> Enabling services to start on boot..."
arch-chroot "$BUILD_DIR" systemctl enable $SERVICES

if [[ -n "$CUSTOM_SCRIPTS_DIR" ]]; then
  echo ">>> Copying custom scripts to chroot..."
  SCRIPT_TEMP_DIR="/root/custom_scripts"
  mkdir -p "$BUILD_DIR/$SCRIPT_TEMP_DIR"
  cp -r "$CUSTOM_SCRIPTS_DIR"/* "$BUILD_DIR/$SCRIPT_TEMP_DIR/"
  echo ">>> Making custom scripts executable and running main.sh..."
  arch-chroot "$BUILD_DIR" bash -c "chmod +x $SCRIPT_TEMP_DIR/* && $SCRIPT_TEMP_DIR/main.sh"
  echo ">>> Cleaning up custom scripts from chroot..."
  rm -rf "$BUILD_DIR/$SCRIPT_TEMP_DIR"
fi

if [[ -z "$ROOT_HAVEPASSWORD" ]]; then
  echo ">>> Please set the password for the root user"
  arch-chroot "$BUILD_DIR" passwd root
else
  arch-chroot "$BUILD_DIR" passwd -d root
fi

echo ">>> Copying a backup of the system image configuration to /etc/config.mkobsfs"
cp "$1" "$BUILD_DIR/etc/config.mkobsfs" || true

if [[ -n "$NETUPDATE" ]]; then
  echo ">>> Enabling obsidianctl netupdate."
  touch "$BUILD_DIR/etc/obsidianctl-netupdate-enable-DONOTDELETE"
fi

echo ">>> Creating the SquashFS image ($OUTPUT_SFS)..."
if ! mksquashfs "$BUILD_DIR" "$OUTPUT_SFS" -noappend -comp xz -processors $(nproc); then
  echo "Error: mksquashfs failed to create the image."
  exit 1
fi

echo ">>> Cleaning up the build directory..."
umount "$BUILD_DIR" || echo ">>> Not mounted. proceeding..."
rm -rf "$BUILD_DIR"
echo "---"
echo ">>> Success! SteamOS ${STEAMOS_VERSION} system image created at: $(pwd)/$OUTPUT_SFS"
echo ">>> Packages included: $PACKAGES"
